---
description: Canonical TS/JS consolidation and safety rule
globs: "*.ts,*.tsx,*.mjs,*.js"
alwaysApply: false
---

> NOTE: Canonical TS/JS rule. Keep this file as the single source of truth for JS/TS actions.

# JS/TS Canonical Rule

## Primary goals

1. Preserve runtime behavior and public contracts.
2. Proactively dedupe/merge parallel implementations.
3. Improve correctness and type-safety with minimal churn.

## Required actions

- Prefer TypeScript in TS codepaths and keep strictness from `tsconfig`.
- Prefer `const`, avoid `var`, and keep public APIs explicitly typed.
- Avoid `any`; prefer `unknown` + narrowing and runtime guards for external input.
- Reuse existing helpers/types before adding new modules.
- Consolidate near-identical helpers/types into one canonical implementation.
- Keep modules cohesive by feature; avoid fragmentation and circular imports.
- Align imports to project aliases; remove unused imports after refactors.

## Canonicalization protocol

When duplicates are found:

1. Identify contract: signature, semantics, side effects, invariants.
2. Choose canonical base by correctness, readability, and typing quality.
3. Merge safely behind stable exports; use thin adapters only when needed.
4. Sweep for same pattern and apply same fix where appropriate.

Hard constraints:

- No new dependencies for simple refactors.
- Avoid call-site churn unless necessary and mechanical.
- Do not hide errors with empty `catch` or silent fallbacks unless explicitly requested.

## Quality gates

- After substantive changes, run relevant checks:
  - `npm run build`
  - `npm run build:crx`
  - `npm run dev`
