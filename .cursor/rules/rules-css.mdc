---
description: Canonical CSS/SCSS refactor and architecture rule
globs: "*.scss,*.css,*.sass"
alwaysApply: false
---

> NOTE: Canonical CSS/SCSS rule. Keep this file as the single source of truth for style actions.

# CSS/SCSS Canonical Rule

## Primary goals

1. Preserve computed styles and visual behavior.
2. Proactively dedupe and consolidate repeated style logic.
3. Keep styles cohesive, low-specificity, and easy to navigate.

## Required refactor actions

- Refactor/optimize/consolidate SCSS and CSS while editing.
- Use 4-space indentation and normalize formatting without unrelated churn.
- Regroup selectors, nesting, custom properties, and rule blocks logically.
- Cleanup/optimize/reduce/merge duplicates and near-duplicates; keep one canonical implementation.
- Use `@layer` logically and merge redundant layer definitions.
- Consolidate `@keyframes`, `@media`, and `@container` blocks where safe.
- Hoist/merge imports, selectors, and shared rules when it reduces duplication.
- Fix syntax breaks and ensure styles compile/lint.

## File and layer structure

Prefer a small top-level partition:

1. meta (`@use`, `@forward`, `@mixin`, `@function`, `@keyframes`, `@property`)
2. tokens
3. base
4. layout
5. components
6. utilities
7. overrides

Layer strategy:

- Keep layer stack small and stable.
- Prefer `@layer tokens, base, layout, components, utilities, overrides;` unless the repo defines another order.
- Resolve conflicts via layers + low specificity, not selector escalation.

## SCSS module and selector guidance

- Prefer `@use`/`@forward` over `@import`.
- Prefer semantic tokens and reusable mixins/functions.
- Prefer low-specificity selectors and limited nesting depth (about 3 levels max).
- Use `:where(...)`/`:is(...)` to reduce selector bloat; use `:has(...)` carefully and scoped.

## Hard constraints

- Global/library SCSS mixins/functions/variables must NOT be inside `@layer`, `@media`, or `@scope`.
- Do not increase selector specificity unless unavoidable.
- Do not change HTML markup/class names/DOM structure.
- Avoid `!important`.
- Preserve visual output unless the task explicitly requires behavior changes.

## Quality gates

- After substantive changes, run relevant checks:
  - `npm run build`
  - `npm run build:crx`
  - `npm run dev`
