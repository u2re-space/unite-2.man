@property --light-az { syntax: '<angle>'; inherits: true; initial-value: 225deg; }
@property --light-alt { syntax: '<angle>'; inherits: true; initial-value: 55deg; }
@property --soft-ang  { syntax: '<angle>'; inherits: true; initial-value: 18deg; }

@property --parallax-k { syntax: '<number>'; inherits: true; initial-value: 0.01; }
@property --parallax-ref { syntax: '<length>'; inherits: true; initial-value: 600px; } // нормализация px->[-1..1]
@property --az-span      { syntax: '<angle>';  inherits: true; initial-value: 12deg; } // макс. отклонение азимута
@property --alt-span     { syntax: '<angle>';  inherits: true; initial-value: 6deg; }  // макс. отклонение высоты

@property --umbra-density    { syntax: '<number>'; inherits: true; initial-value: 0.32; }
@property --penumbra-density { syntax: '<number>'; inherits: true; initial-value: 0.18; }

/* «высота» элемента над плоскостью */
@property --elev { syntax: '<number>'; inherits: false; initial-value: 0; }

/* Альтернатива: источник как 3D-вектор (если не хотите вручную углы) */
@property --lx { syntax: '<number>'; inherits: true; initial-value: -1; }
@property --ly { syntax: '<number>'; inherits: true; initial-value: -1; }
@property --lz { syntax: '<number>'; inherits: true; initial-value: 1.2; }

/* shadow properties */
@property --z-index { syntax: '<number>'; inherits: true; initial-value: 0; }
@property --dx { syntax: '<number>'; inherits: true; initial-value: 0; }
@property --dy { syntax: '<number>'; inherits: true; initial-value: 0; }
@property --spreadC { syntax: '<number>'; inherits: true; initial-value: 0; }
@property --spreadU { syntax: '<number>'; inherits: true; initial-value: 0; }
@property --spreadP { syntax: '<number>'; inherits: true; initial-value: 0; }
@property --alphaC { syntax: '<number>'; inherits: true; initial-value: 0; }
@property --alphaU { syntax: '<number>'; inherits: true; initial-value: 0; }
@property --alphaP { syntax: '<number>'; inherits: true; initial-value: 0; }

/* animations */
@keyframes lift {
    from { --elev: 6; }
    to   { --elev: 32; }
}

/* */
@keyframes daylight {
    0%   { --light-az: 210deg; --light-alt: 30deg; }
    50%  { --light-az: 270deg; --light-alt: 70deg; }
    100% { --light-az: 330deg; --light-alt: 30deg; }
}





/*
.elev-drop {
    --elev: 12px;
    --cotA: calc(1 / max(0.001, tan(var(--light-alt))));
    --L: calc(abs(var(--elev)) * var(--cotA));
    --dx: calc(cos(var(--light-az)) * var(--L) * sign(var(--elev)));
    --dy: calc(sin(var(--light-az)) * var(--L) * sign(var(--elev)));

    --b1: calc(max(0.5px, abs(var(--elev)) * tan(var(--soft-ang)) * 0.8));
    --b2: calc(var(--b1) * 2.0);
    --b3: calc(var(--b1) * 3.2);

    filter:
        drop-shadow(calc(var(--dx) * 0.15) calc(var(--dy) * 0.15) var(--b1) rgb(0 0 0 / 0.20))
        drop-shadow(var(--dx) var(--dy) var(--b2) rgb(0 0 0 / 0.12))
        drop-shadow(var(--dx) var(--dy) var(--b3) rgb(0 0 0 / 0.07));
}
*/


@mixin shadow-drop() {
    --relate-x: calc(var(--drag-x, 0) + var(--shift-x, 0) - (100cqi / 2px));
    --relate-y: calc(var(--drag-y, 0) + var(--shift-y, 0) - (100cqb / 2px));

    /* нормализованные relate -> [-1..1] */
    --relNX: calc(clamp(-1, (var(--relate-x, 0) / var(--parallax-ref)), 1));
    --relNY: calc(clamp(-1, (var(--relate-y, 0) / var(--parallax-ref)), 1));

    /* итоговые углы света с «покачиванием» */
    --light-az:  calc(var(--az-base)  + var(--relNX) * var(--az-span));
    --light-alt: calc(var(--alt-base) + var(--relNY) * var(--alt-span));

    /* высота (может быть отрицательной; единицы — px для наглядности) */
    --elev: calc((var(--z-index, 0) + 2) * 2);

    /* Можно анимировать: теперь это типизированное свойство */
    //transition: --elev .3s ease, box-shadow .3s ease, transform .3s ease;

    /* опционально: ощущение глубины той же переменной */
    //transform: translateZ(var(--elev));

    /* длина тени по плоскости: L = |elev| * cot(alt) */
    --cotA: calc(1 / max(0.001, tan(var(--light-alt))));
    --L: calc(abs(var(--elev)) * var(--cotA));

    /* смещение тени по осям (учтём знак высоты через sign) */
    --dx: calc(cos(var(--light-az)) * var(--L) * sign(var(--elev)));
    --dy: calc(sin(var(--light-az)) * var(--L) * sign(var(--elev)));

    /* */
    --sx: calc((var(--dx) + var(--relate-x) * var(--parallax-k)) * 1px);
    --sy: calc((var(--dy) + var(--relate-y) * var(--parallax-k)) * 1px);

    /* мягкость: пропорциональна высоте и угловому размеру источника */
    --blurC: calc(max(0.5, abs(var(--elev)) * tan(var(--soft-ang))));   /* контактная */
    --blurU: calc(var(--blurC) * 1.6);                              /* умбра */
    --blurP: calc(var(--blurC) * 2.8);                              /* пенумбра */

    /* spread: с ростом высоты тень «расходится» (отрицательный spread) */
    --spreadC: calc(abs(var(--elev)) * 0.04);
    --spreadU: calc(abs(var(--elev)) * 0.10);
    --spreadP: calc(var(--spreadU) * 1.2);

    /* плотность убывает с высотой (гладкая, без ступенек) */
    --alphaC: calc(clamp(0.08, (var(--umbra-density) * 0.9) / (1 + abs(var(--elev)) * 0.30), 0.40));
    --alphaU: calc(clamp(0.06, var(--umbra-density) / sqrt(1 + abs(var(--elev)) * 0.15), 0.35));
    --alphaP: calc(clamp(0.04, var(--penumbra-density) / sqrt(1 + abs(var(--elev)) * 0.08), 0.25));

    /* стек слоёв: контактная + умбра + пенумбра */
    filter:
        drop-shadow(calc(var(--sx) * 0.15) calc(var(--sy) * 0.15) calc(var(--blurC) * 1px) #{"rgb(0 0 0 / var(--alphaC))"})
        drop-shadow(var(--sx) var(--sy) calc(var(--blurU) * 1px) #{"rgb(0 0 0 / var(--alphaU))"})
        drop-shadow(var(--sx) var(--sy) calc(var(--blurP) * 1px) #{"rgb(0 0 0 / var(--alphaP))"})
        !important;
}



/* подключайте этот блок к любому «поднятому» элементу */
.elev, ui-window-frame, .shadow-wrap, .ctx-menu, .ui-frame {
    filter: drop-shadow(0px 0px calc(max(0.125 + var(--z-index, 0) * 0.125, 0) * 1rem) #00000040);
    //@include shadow-drop;
}

/* scene */
.scene, :root {
    /* куда «смотрит» свет: -x,-y, +z — пример «сверху-слева» */
    --lx: -0.01;
    --ly: -0.01;
    --lz: 8;

    /* базовые углы из вектора */
    --az-base:  calc(atan2(var(--ly), var(--lx)));
    --alt-base: calc(atan2(var(--lz), hypot(var(--lx), var(--ly))));

    /* азимут и высота из вектора */
    --light-az: calc(atan2(var(--ly), var(--lx))); /* направление в плоскости XY */
    --light-alt: calc(atan2(var(--lz), hypot(var(--lx), var(--ly))));

    /* угловой размер источника (мягкость) */
    --soft-ang: 12deg;

    /* плотности для разных слоёв тени */
    --umbra-density: 0.32;     /* основная тень */
    --penumbra-density: 0.18;  /* полутень */
}

/* animations */
.pulsing { animation: lift 1.6s ease-in-out infinite alternate; }
.scene.sun-move { animation: daylight 8s linear infinite; }
